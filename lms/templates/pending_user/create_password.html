<%namespace name='static' file='/static_content.html'/>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="${static.url(static.get_value('favicon_path', settings.FAVICON_PATH))}"
    />
    <title>Funix Create Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3C6AF3",
            },
            boxShadow: {
              bottom: "0px 25px 90px -57px #1069fe",
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Open Sans", sans-serif;
      }

      @media (max-width: 770px) {
        .bg-image {
          display: none;
        }
      }
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.8);
        z-index: 999999;
      }
      .loading--hidden {
        opacity: 0;
        visibility: hidden;
      }
      .loading::after {
        content: "";
        width: 75px;
        height: 75px;
        border-top-color: #0d7dfc !important;
        border: 10px solid #dddd;
        border-radius: 50%;
        animation: loading 0.75s ease infinite;
      }
      @keyframes loading {
        from {
          transform: rotate(0turn);
        }
        to {
          transform: rotate(1turn);
        }
      }
    </style>
  </head>

  <body class="h-screen overflow-hidden">
    <main
      class="h-full flex flex-col md:flex-row justify-center items-center gap-12 p-5 md:p-0"
    >
      <div class="hidden md:w-[530px] md:block self-center">
        <div class="">
          <img
            src="https://res.cloudinary.com/dvlbv6l2k/image/upload/v1711090680/chage-pw_cycaqf.jpg"
            alt="student"
            class="w-full"
          />
        </div>
        <div class="italic text-sm text-center w-full">
          <div>
            Bạn làm theo hướng dẫn từng bước trên đây để book lịch học thử với
            gia sư. Nếu có bất kỳ vướng mắc nào cần giải đáp, bạn vui lòng liên
            hệ email hoặc hotline FUNiX dưới đây!
          </div>
          <div>Hotline: 078.2313.602 (Zalo/Viber)</div>
          <div>Email: info@funix.edu.vn</div>
        </div>
      </div>

      <div class="text-center self-center mb-4 w-fit md:w-[530px] mt-0 md:mt-6">
        <div class="p-4 md:p-6 shadow-bottom">
          <div class="font-bold text-2xl md:text-3xl mb-3 text-primary">
            Tạo tài khoản
          </div>
          <div class="font-bold text-base md:text-xl text-orange-500 mt-4 mb-2">
            CHỦ ĐỘNG BOOK LỊCH - HỌC THỬ MIỄN PHÍ
          </div>
          <div class="text-md font-semibold mt-2 md:mt-4">
            Vui lòng nhập mật khẩu và xác nhận mật
          </div>
          <div class="text-md font-semibold">khẩu đăng nhập</div>
          <form
            action=""
            class="flex flex-col items-center"
            onsubmit="submitForm(event)"
          >
            <div
              class="flex justify-between items-center gap-3 bg-neutral-100 py-4 px-6 w-full md:w-[80%] rounded-md my-2 md:my-4"
            >
              <input
                class="w-full md:w-80 text-sm md:text-base bg-transparent outline-none"
                type="password"
                name="password"
                id="password1"
                placeholder="Nhập mật khẩu"
              />
              <i class="fa-regular fa-eye cursor-pointer show-password"></i>
            </div>
            <div
              class="flex justify-between items-center gap-3 bg-neutral-100 py-4 px-6 w-full md:w-[80%] rounded-md"
            >
              <input
                class="w-full md:w-80 text-sm md:text-base bg-transparent outline-none"
                type="password"
                name="confirm"
                id="password2"
                placeholder="Xác nhận mật khẩu"
              />
              <i class="fa-regular fa-eye cursor-pointer show-password"></i>
            </div>

            <div class="relative mt-8 md:mt-10 mb-8 w-full md:w-[80%]">
              <div
                id="error-message"
                class="absolute top-[-25px] left-0 text-xs text-red-500 italic"
              ></div>
              <button
                id="btn"
                class="bg-primary text-white w-full py-3 md:py-4 font-semibold rounded-md hover:bg-sky-700 disabled:opacity-75 disabled:pointer-events-none"
              >
                Xác thực
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <div class="loading loading--hidden"></div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const button = document.querySelector("button");
        const passwordInput1 = document.querySelector("#password1");
        const passwordInput2 = document.querySelector("#password2");
        const loadingPage = document.querySelector(".loading");

        const jwt = localStorage.getItem("jtc");
        const lead_id = localStorage.getItem("li");
        const course_id = localStorage.getItem("ci");

        button.addEventListener("click", function () {
          const password1 = passwordInput1.value;
          const password2 = passwordInput2.value;

          if (!validatePasswords(password1, password2)) {
            return;
          }

          loadingPage.classList.remove("loading--hidden");
          let csrfToken = document.cookie
            .split("; ")
            .find((row) => row.startsWith("csrftoken="))
            .split("=")[1];

          const currentUrl = window.location.origin;
          const createPasswordUrl =
            currentUrl + "/api-pending-user/create-password";
          fetch(createPasswordUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({
              jwt: jwt,
              password: password1,
              lead_id: lead_id,
              course_id: course_id,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              loadingPage.classList.add("loading--hidden");
              if (data.success) {
                window.location.href = "/book-giasu";
                localStorage.removeItem("jtc");
                localStorage.removeItem("li");
                localStorage.removeItem("ci");
              } else if (data.error == "user_already_exists") {
                alert("Bạn đã có tài khoản FUNiX. Vui lòng đăng nhập.");
                window.location.href = "/login-phone";
              } else {
                alert("Failed to create password. Please try again.");
              }
            })
            .catch((error) => {
              loadingPage.classList.add("loading--hidden");
              console.error("Error:", error);
              alert("Đăng ký tài khoản không thành công. Vui lòng thử lại.");
              window.location.href = "/register-phone";
            });
        });

        function validatePasswords(password1, password2) {
          if (!password1 || !password2) {
            alert("Vui lòng nhập mật khẩu!");
            return false;
          }
          if (password1.indexOf(" ") >= 0) {
            alert(
              "Mật khẩu không được chứa khoảng trắng. Vui lòng nhập lại mật khẩu!"
            );
            return false;
          }
          if (password1 !== password2) {
            alert("Mật khẩu bạn nhập không khớp. Vui lòng nhập lại mật khẩu!");
            return false;
          }
          if (password1.length < 4) {
            alert(
              "Mật khẩu phải có ít nhất 4 ký tự. Vui lòng nhập lại mật khẩu!"
            );
            return false;
          }
          if (password1.length > 20) {
            alert(
              "Mật khẩu phải có tối đa 20 ký tự. Vui lòng nhập lại mật khẩu!"
            );
            return false;
          }
          return true;
        }
      });
    </script>
  </body>
</html>
