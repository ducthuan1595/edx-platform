<%namespace name='static' file='/static_content.html'/>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="${static.url(static.get_value('favicon_path', settings.FAVICON_PATH))}"
    />
    <title>Learn with Mentors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Open Sans", sans-serif;
      }

      /* @media (max-width: 770px) {
        .bg-image {
          display: none;
        }
      } */
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#3C6AF3",
            },
            boxShadow: {
              bottom: "0px 25px 90px -57px #1069fe",
            },
          },
        },
      };
    </script>
  </head>
  <body class="h-screen overflow-hidden">
    <div
      class="h-full flex flex-col md:flex-row justify-center items-center gap-12 p-5 md:p-0"
    >
      <!-- Left side with image -->
      <div class="hidden md:w-[530px] md:block self-center">
        <div class="">
          <img
            src="https://res.cloudinary.com/dvlbv6l2k/image/upload/v1711014922/enter-otp_whp3sf.jpg"
            alt="student"
            class="w-full"
          />
        </div>
        <div class="italic text-sm text-center w-fit">
          <div>
            Bạn làm theo hướng dẫn từng bước trên đây để book lịch học thử với
            gia sư. Nếu có bất kỳ vướng mắc nào cần giải đáp, bạn vui lòng liên
            hệ email hoặc hotline FUNiX dưới đây!
          </div>
          <div>Hotline: 078.2313.602 (Zalo/Viber)</div>
          <div>Email: info@funix.edu.vn</div>
        </div>
      </div>
      <!-- Right side with form -->
      <div class="text-center self-center mb-4 w-fit md:w-[530px] mt-0 md:mt-6">
        <div class="p-4 md:p-6 shadow-bottom">
          <div class="font-bold text-2xl md:text-3xl mb-3 text-primary">
            Tạo tài khoản
          </div>
          <div class="font-bold text-base md:text-xl text-orange-500 mt-4 mb-2">
            CHỦ ĐỘNG BOOK LỊCH - HỌC THỬ MIỄN PHÍ
          </div>
          <div class="text-md font-semibold mt-2">
            Vui lòng nhập mã xác thực
          </div>
          <div class="text-md font-semibold mb-4 md:mb-6">
            vừa được gửi tới số điện thoại của bạn
          </div>
          <div class="flex flex-col items-center">
            <div
              class="flex justify-start items-center gap-3 bg-neutral-100 py-4 px-6 w-full md:w-[80%] rounded-md my-2 md:my-2"
            >
              <input
                class="w-full md:w-80 text-center text-sm md:text-base bg-transparent outline-none"
                type="text"
                name="otp-code"
                placeholder="Nhập mã OTP"
                id="otp"
              />
            </div>
            <p id="countdown" class="text-center text-gray-500 mt-2"></p>
            <div class="mt-3 md:mt-4 w-full md:w-[80%]">
              <button
                id="verify-otp"
                disabled
                class="bg-primary text-white w-full py-3 md:py-4 font-semibold rounded-md hover:bg-sky-700 disabled:opacity-75 disabled:pointer-events-none"
              >
                Xác thực
              </button>
            </div>
            <div
              class="text-xs md:text-sm italic flex justify-center items-center gap-2 w-full md:w-[80%] my-4"
            >
              Mã OTP sẽ tự động hết hiệu lực trong 5 phút Nếu OTP hết hiệu lực,
              bạn vui lòng bấm gửi lại mã xác thực 
            </div>
            <div class="w-full md:w-[80%]">
              <button
                id="resend-otp"
                class="bg-orange-500 text-white w-full font-semibold hover:bg-sky-700 rounded-md py-2 md:py-3"
              >
                Gửi lại mã xác thực
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const countdownTimer = document.querySelector("#countdown");
        const resendOtpMessage = document.querySelector("#resend-otp");
        const verifyOtpButton = document.querySelector("#verify-otp");
        const otpInput = document.querySelector("#otp");
        const urlParams = new URLSearchParams(window.location.search);
        const phone = urlParams.get("p");
        let initialTime = 300;
        let time = initialTime;

        otpInput.addEventListener("input", function () {
          if (otpInput.value.trim() !== "") {
            verifyOtpButton.disabled = false;
          } else {
            verifyOtpButton.disabled = true;
          }
        });

        // Start the countdown
        let countdown = startCountdown();

        // Create a function to start the countdown
        function startCountdown() {
          // Update the countdown every second
          let countdown = setInterval(function () {
            // Calculate the minutes and seconds from time
            let minutes = Math.floor(time / 60);
            let seconds = time % 60;

            countdownTimer.textContent =
              minutes + ":" + (seconds < 10 ? "0" : "") + seconds;

            // Decrease time
            time--;

            // If the countdown has finished
            if (time < 0) {
              // Stop the countdown
              clearInterval(countdown);
              countdownTimer.style.display = "none";
              countdownTimer.textContent = "5:00";
              resendOtpMessage.style.display = "block";
            }
          }, 1000);

          return countdown;
        }

        // Add an event listener to the resend OTP message
        resendOtpMessage.addEventListener("click", async function () {
          console.log("click");
          // Hide the resend OTP message and show the countdown timer
          this.style.display = "none";
          countdownTimer.style.display = "block";
          // Reset the countdown time and stop the old countdown
          time = initialTime;
          clearInterval(countdown);
          // Convert the phone number to the 84 format
          let phoneFormat84 = convertPhoneToFormat84(atob(phone));
          // Redirect to 'register-phone' if the phone number is not valid
          const phoneRegex = /^(84|0)\d{9}$/;
          if (!phoneRegex.test(phoneFormat84)) {
            window.location.href = "register-phone";
            return;
          }

          try {
            await sendOtp(phoneFormat84);
            // Start a new countdown
            countdown = startCountdown();
          } catch (error) {
            console.error(error);
            alert(error.message);
            window.location.href = "register-phone";
          }
        });

        const convertPhoneToFormat84 = (phone) => {
          const format84Phone = phone.replace(/^0/, "84");
          return format84Phone;
        };

        const sendOtp = async (format84Phone) => {
          try {
            let csrfToken = document.cookie
              .split("; ")
              .find((row) => row.startsWith("csrftoken="))
              .split("=")[1];

            const currentUrl = window.location.origin;
            const sendOtpUrl = currentUrl + "/api-pending-user/send-otp";
            const response = await fetch(sendOtpUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              body: JSON.stringify({
                phone: format84Phone,
              }),
            });

            const data = await response.json();

            if (data.success) {
              return data;
            } else {
              throw new Error(
                "Gửi mã OTP không thành công. Xin vui lòng thử lại."
              );
            }
          } catch (error) {
            console.error("Error:", error);
            throw error;
          }
        };

        verifyOtpButton.addEventListener("click", function () {
          if (!phone) {
            window.location.href = "register-phone";
            return;
          }

          const otp = otpInput.value;

          // Validate the OTP
          const otpRegex = /^\d{6}$/;
          if (!otpRegex.test(otp)) {
            alert("Invalid OTP. It must be a 6-digit number.");
            return;
          }

          // Send the POST request
          const rootUrl = window.location.origin;
          const validateOtpUrl = rootUrl + "/api-pending-user/validate-otp";
          fetch(validateOtpUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              otp: otp,
              phone: phone,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // save jwt to local storage
                localStorage.setItem("jtc", data.jwt);
                // Redirect to create-password
                window.location.href = "create-password";
              } else {
                alert("Failed to verify OTP. Please try again.");
                window.location.href = "register-phone";
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });
      });
    </script>
  </body>
</html>
